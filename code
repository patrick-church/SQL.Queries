sql1 = '''
SELECT camis, dba, viol_desc, viol_id, count(*) as NumViol
FROM tInsp
JOIN tViol USING(viol_id)
JOIN tRest USING(camis)
WHERE viol_desc LIKE "%vermin%" OR viol_desc LIKE "%mice%" OR viol_desc LIKE "%rats%"
GROUP BY camis, viol_desc
ORDER BY NumViol DESC
;'''
d.run_query(sql1)



sql2 = '''
WITH
ViolBYCuisineViol_id as 
(
  SELECT count(*) as NumViol, cuisine, viol_id, viol_desc
  FROM tInsp
  JOIN tViol USING(viol_id)
  JOIN tRest USING(camis)
  GROUP BY cuisine, viol_id
)
SELECT cuisine, viol_id, viol_desc, max(NumViol) as NumViol
FROM (ViolBYCuisineViol_id)
WHERE viol_id NOT LIKE "%10f%"
GROUP BY cuisine
HAVING NumViol > 1000
ORDER BY cuisine ASC
;'''
d.run_query(sql2)




sql3 = '''
SELECT action_desc, viol_desc, count(*) as NumViol
FROM tInsp
JOIN tViol USING(viol_id)
JOIN tAction USING(action_id)
WHERE action_desc LIKE "%closed%"
GROUP BY viol_desc, action_desc
ORDER BY NumViol DESC
LIMIT 5
;'''
d.run_query(sql3)




sql4 = '''
WITH
MostClosedCamis as
(
  SELECT count(*) as MostClosed, camis, dba
  FROM tInsp
  JOIN tViol USING(viol_id)
  JOIN tAction USING(action_id)
  JOIN tRest USING(camis)
  WHERE action_desc LIKE "%closed%"
  GROUP BY camis
  ORDER BY MostClosed DESC
  LIMIT 1
)
SELECT camis, dba, viol_desc, count(*) as NumViol
FROM tInsp
JOIN tViol USING(viol_id)
JOIN tAction USING(action_id)
JOIN tRest USING(camis)
WHERE camis LIKE (SELECT camis FROM MostClosedCamis)
GROUP BY viol_id
ORDER BY NumViol DESC
;'''
d.run_query(sql4)




sql5 = '''
SELECT dba, TotalRestNum, NumViol, 1.0*NumViol/TotalRestNum as AvgViolsPerLoc
FROM (
    SELECT count(DISTINCT(camis)) as TotalRestNum, count(camis) as NumViol, dba
    FROM tInsp
    JOIN tViol USING(viol_id)
    JOIN tAction USING(action_id)
    JOIN tRest USING(camis)
    GROUP BY dba
    ORDER by TotalRestNum DESC
    )
;'''
d.run_query(sql5)




sql6 = '''
WITH
RestList as
  (
  SELECT camis, dba, count(DISTINCT(camis)) as GetRest, viol_id
  FROM tInsp
  JOIN tViol USING(viol_id)
  JOIN tRest USING(camis)
  GROUP BY dba
  HAVING GetRest = 1
  ),
TotalViolNum as
  (
  SELECT camis, dba, count(*) as NumViol
  FROM tInsp
  JOIN tViol USING(viol_id)
  JOIN tRest USING(camis)
  WHERE camis IN (SELECT camis FROM RestList)
  GROUP BY dba
  HAVING NumViol > 10
  ORDER BY NumViol
  ),
NoMore as
  (
  SELECT camis, dba, count(*) as NumViol, viol_desc
  FROM tInsp
  JOIN tViol USING(viol_id)
  JOIN tRest USING(camis)
  WHERE camis IN (SELECT camis FROM TotalViolNum)
  GROUP BY dba, viol_id
  ORDER BY NumViol DESC
  )
SELECT camis, dba, viol_desc, Max(NumViol) as NumViol
FROM NoMore
GROUP BY dba
HAVING NumViol >= 15
ORDER BY NumViol DESC
;'''
d.run_query(sql6)




sql7 = '''
WITH
AllCombs as
  (
   SELECT viol_id, action_id
   FROM tViol
   JOIN tAction
  ),
HasOccurred as
  (
   SELECT DISTINCT viol_id, action_id
   FROM tInsp
  )
SELECT count(*)
FROM(
SELECT AllCombs.action_id, AllCombs.viol_id, HasOccurred.action_id
FROM AllCombs
LEFT JOIN HasOccurred USING(action_id, viol_id)
WHERE HasOccurred.action_id IS NULL
)






sql8 = '''
WITH
AllCombs as
  (
  SELECT viol_id, action_id
  FROM tViol
  JOIN tAction
  ),
HasOccurred as
  (
  SELECT DISTINCT viol_id, action_id
  FROM tInsp
  )
SELECT action_desc, viol_desc
FROM AllCombs
LEFT JOIN HasOccurred USING(action_id, viol_id)
JOIN tViol USING(viol_id)
JOIN tAction USING(action_id)
WHERE HasOccurred.action_id IS NULL
ORDER BY viol_desc ASC
d.run_query(sql8)








sql9 = '''
WITH 
NumViol>90 as 
  (
  SELECT count(*) as NumViol, camis, dba
  FROM tInsp
  JOIN tRest USING(camis)
  JOIN tViol USING(viol_id)
  GROUP BY camis
  HAVING NumViol >= 90
  ),
ViolByCamis as
  (
  SELECT camis, dba, viol_id, viol_desc, count(*) as NumViol
  FROM tInsp
  JOIN tRest USING(camis)
  JOIN tViol USING(viol_id)
  WHERE camis IN (SELECT camis FROM NumViol>90)
  GROUP BY viol_id, camis
  )
SELECT camis, dba, viol_id, viol_desc, max(NumViol) as NumViol
FROM ViolByCamis
GROUP BY camis
ORDER BY dba ASC
;'''
d.run_query(sql9)



